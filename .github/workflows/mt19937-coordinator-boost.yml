name: Boost mt19937 cross-OS coordinator
on:
  workflow_dispatch:
jobs:
  build-and-run:
    name: Build and run Boost emitter (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    # no job-level env needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang
          # Install Boost.Random only
          sudo apt-get install -y libboost-random-dev

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install llvm
          # Homebrew provides Boost as a single formula; we'll use headers/libs from it
          brew install boost
          echo "Using clang++ from Homebrew"
          echo "CXX=$(brew --prefix)/opt/llvm/bin/clang++" >> $GITHUB_ENV

      - name: Set up Visual Studio shell (Windows)
        if: startsWith(matrix.os, 'windows')
        uses: egor-tensin/vs-shell@v2
        with:
            arch: x64

      - name: vcpkg (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: |
          # Use preinstalled vcpkg from runner images
          $env:VCPKG_ROOT = $env:VCPKG_INSTALLATION_ROOT  # Expected: C:\vcpkg
          & "$env:VCPKG_ROOT\vcpkg.exe" install boost-random:x64-windows
          Write-Host "VCPKG include: $env:VCPKG_ROOT\installed\x64-windows\include"
          "$env:VCPKG_ROOT\installed\x64-windows\include" | Out-File -FilePath include_path.txt -Encoding ascii

      - name: Build (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          c++ -std=c++17 test/tech/mt19937_emit_boost.cpp -o mt19937_emit_boost

      - name: Build (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          "$CXX" -std=c++17 -I"$(brew --prefix)/include" -L"$(brew --prefix)/lib" test/tech/mt19937_emit_boost.cpp -o mt19937_emit_boost

      - name: Build (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: cmd
        run: |
          set INCLUDE=%VCPKG_ROOT%\installed\x64-windows\include;%INCLUDE%
          cl /std:c++17 /EHsc /I "%VCPKG_ROOT%\installed\x64-windows\include" test\tech\mt19937_emit_boost.cpp /Fe:mt19937_emit_boost.exe

      - name: Run emitter
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ./mt19937_emit_boost.exe > boost_emit_${{ matrix.os }}.txt
          else
            ./mt19937_emit_boost > boost_emit_${{ matrix.os }}.txt
          fi
        # no env needed

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boost-emit-${{ matrix.os }}
          path: boost_emit_${{ matrix.os }}.txt

  compare-outputs:
    name: Compare outputs
    runs-on: ubuntu-latest
    needs: build-and-run
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Diff Ubuntu vs macOS
        run: |
          dos2unix artifacts/boost-emit-ubuntu-latest/boost_emit_ubuntu-latest.txt || true
          dos2unix artifacts/boost-emit-macos-latest/boost_emit_macos-latest.txt || true
          diff -u artifacts/boost-emit-ubuntu-latest/boost_emit_ubuntu-latest.txt artifacts/boost-emit-macos-latest/boost_emit_macos-latest.txt || (echo "Differences found between Ubuntu and macOS" && exit 1)

      - name: Diff Ubuntu vs Windows (normalize CRLF)
        run: |
          dos2unix artifacts/boost-emit-ubuntu-latest/boost_emit_ubuntu-latest.txt || true
          dos2unix artifacts/boost-emit-windows-latest/boost_emit_windows-latest.txt || true
          diff -u artifacts/boost-emit-ubuntu-latest/boost_emit_ubuntu-latest.txt artifacts/boost-emit-windows-latest/boost_emit_windows-latest.txt || (echo "Differences found between Ubuntu and Windows" && exit 1)