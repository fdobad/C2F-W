---
name: Build macOS (dynamic & static lib.linking)
on:
  workflow_dispatch:
  workflow_call:
permissions:
  contents: write
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM64 builds on macOS 14 Sonoma
          - runner: macos-14
            arch: arm64
            type: dynamic
          - runner: macos-14
            arch: arm64
            type: static
          # ARM64 builds on macOS 15 Sequoia
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds on macOS 15
          - runner: macos-15-intel
            arch: x86_64
            type: dynamic
          - runner: macos-15-intel
            arch: x86_64
            type: static
    runs-on: ${{ matrix.runner }}
    continue-on-error: true
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
      - name: Install gsed for version bumping
        run: brew install gsed
      - name: Bump Version in Code
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
          else
            version="${{ github.sha }}"
          fi
          echo "Setting version to ${version}"
          gsed -i "s/C2FW_VERSION.*/C2FW_VERSION = \"${version}\";/" Cell2Fire/Cell2Fire.h
          grep C2FW_VERSION Cell2Fire/Cell2Fire.h
      - name: Set Environment
        run: |
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
          echo "Building for: ${KERNEL} on ${{ matrix.runner }} (${MACHINE})"
          echo "matrix attributes:: type:${{ matrix.type }}, arch:${{ matrix.arch }}, runner:${{ matrix.runner }}"
      - name: Install Dependencies
        run: |
          brew install gcc libomp boost libtiff
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew install jpeg-turbo xz zstd zlib
          else
            brew install catch2
          fi
      - name: Check Brew Package Versions
        run: |
          brew list --versions gcc libomp boost libtiff > "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew list --versions jpeg-turbo xz zstd zlib >> "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          fi
          cat "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
      - name: Debug show stuff
        if: true
        env:
          MATRIX_TYPE: ${{ matrix.type }}
        run: |
          set -x
          g++ --version
          which g++
          ls $(brew --prefix boost)
          ls $(brew --prefix libomp)
          ls $(brew --prefix libtiff)
          brew install tree 
          set +x
          function ls_brew_pkg() {
           pkg_name=$1
           pkg_prefix=$(brew --prefix $pkg_name)
           echo "Listing for $pkg_name at $pkg_prefix"
           # ls -lR "$pkg_prefix/lib" 2>/dev/null || echo "lib does not exist"
           # ls -lR "$pkg_prefix/include" 2>/dev/null || echo "include does not exist"
           tree -L 1 "$pkg_prefix/lib" || echo "Cannot tree $pkg_prefix"
           tree -L 1 "$pkg_prefix/include" || echo "Cannot tree $pkg_prefix"
          }
          # ls_brew_pkg boost
          ls_brew_pkg libomp
          ls_brew_pkg libtiff
          if [[ "$MATRIX_TYPE" == *dynamic* ]]; then 
            ls $(brew --prefix catch2)
            ls_brew_pkg catch2
            echo "catch2 v: $(brew list --versions catch2 | cut -d' ' -f2 | sort -V | tail -n1 | cut -d. -f1)"
          fi
          
      - name: Build (& Test if dynamic)
        run: |
          cd Cell2Fire
          if [[ "${{ matrix.type }}" == "static" ]]; then
            make -f makefile.macos-static info
            make -f makefile.macos-static clean
            make -f makefile.macos-static
          else
            make -f makefile.macos info
            make -f makefile.macos clean
            make -f makefile.macos tests
            make -f makefile.macos
          fi
      - name: Get Binary Info
        run: |
          cd Cell2Fire
          otool -L Cell2Fire > "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          cat "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"
      - name: Prepare Artifacts
        run: |
          cd Cell2Fire
          mv Cell2Fire "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"
          ls -lh "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"
      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binaries${{ env.SUFFIX }}-${{ matrix.type }}
          path: |
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}-${{ matrix.type }}.txt
            Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt
          if-no-files-found: error
  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM64 builds on macOS 14 Sonoma
          - runner: macos-14
            arch: arm64
            type: dynamic
          - runner: macos-14
            arch: arm64
            type: static
          # ARM64 builds on macOS 15 Sequoia
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds on macOS 15
          - runner: macos-15-intel
            arch: x86_64
            type: dynamic
          - runner: macos-15-intel
            arch: x86_64
            type: static
    runs-on: ${{ matrix.runner }}
    continue-on-error: true
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set Environment
        run: |
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV

      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
          name: binaries${{ env.SUFFIX }}-${{ matrix.type }}
          path: Cell2Fire

      - name: Install Dependencies
        if: contains(matrix.type, 'dynamic')
        run: |
          brew install libomp boost libtiff

      - name: Test Dynamic Binary
        run: |
          chmod +x Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
          cd test
          bash test.sh "${{ env.SUFFIX }}-${{ matrix.type }}"
