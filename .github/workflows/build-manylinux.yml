name: Build ManyLinux (Static)

on:
  workflow_dispatch:
  workflow_call:

env:
  STATIC_BUILD_DEPS: "g++ make libboost-dev libtiff-dev libjpeg-dev libjbig-dev liblzma-dev libzstd-dev libwebp-dev libdeflate-dev libleptonica-dev liblerc-dev"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Bump Version in Code
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
          else
            version="${{ github.sha }}"
          fi
          echo "Setting version to ${version}"
          sed -i "s/C2FW_VERSION.*/C2FW_VERSION = \"${version}\";/" Cell2Fire/Cell2Fire.h

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ env.STATIC_BUILD_DEPS }}

      - name: Build Static Binary
        run: |
          cd Cell2Fire
          make clean
          make -f makefile.static

      - name: Check Package Versions
        run: |
          cd Cell2Fire
          echo "Checking installed dependencies versions:"
          dpkg-query -W -f='${binary:Package} ${Version}\n' ${{ env.STATIC_BUILD_DEPS }} | tee pkgs_manylinux.txt

      - name: Verify Static Linking
        run: |
          cd Cell2Fire
          echo "Checking dynamic dependencies (should be minimal):"
          ldd Cell2Fire 2>&1 | tee ldd_manylinux.txt

      - name: Upload Static Binary
        uses: actions/upload-artifact@v5
        with:
          name: binaries-manylinux-x86_64
          path: |
            Cell2Fire/Cell2Fire
            Cell2Fire/ldd_manylinux.txt
            Cell2Fire/pkgs_manylinux.txt
          if-no-files-found: error

  test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Install Test Dependencies
        run: |
          apt-get update
          apt-get install -y unzip g++ make catch2 libboost-dev libtiff-dev

      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
          name: binaries-manylinux-x86_64
          path: Cell2Fire

      - name: Make Binary Executable
        run: |
          chmod +x Cell2Fire/Cell2Fire

      - name: Build and Run Unit Tests (Dynamic Build for Testing)
        run: |
          cd Cell2Fire
          make clean
          make tests
          ./test_cell2fire

      - name: Run Integration Tests with Static Binary
        run: |
          cd test
          bash test.sh
