name: Build Windows

on:
  workflow_dispatch:
    inputs:
      enabled:
        description: 'Enable the full Windows build (set false to upload placeholder)'
        required: false
        type: boolean
        default: true
  workflow_call:
    inputs:
      enabled:
        description: 'Enable the full Windows build (set false to upload placeholder)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

env:
  ENABLED: ${{ inputs.enabled }}

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Skip Build (Placeholder)
        if: env.ENABLED != 'true'
        shell: bash
        run: |
          echo "Windows build disabled"
          mkdir -p binaries
          echo "Windows build disabled - set workflow input 'enabled: true' to build" > binaries/WINDOWS_BUILD_WAS_DISABLED.txt

      - name: Bump Version in Code
        if: env.ENABLED == 'true'
        shell: pwsh
        run: |
          if ( "${{ github.event_name }}" -eq "pull_request" ){
            $version="${{ github.sha }}"
          }
          elseif ("${{ github.event_name }}" -eq "workflow_dispatch" ){
            $version="${{ github.sha }}"
          } 
          elseif ( ("${{github.event_name}}" -eq "push") -and ("${{github.ref_type}}" -eq "tag" )){
            $ref="${{ github.ref }}"
            $version=$ref.Split("/")[-1]
          }
          else {
            $version="${{ github.sha }}"
          }
          
          Write-Host "Setting version to $version"
          
          $path = "Cell2Fire\Cell2Fire.h"
          (Get-Content $path) -replace 'C2FW_VERSION\s*=\s*".*?"', "C2FW_VERSION = `"$version`"" | Set-Content $path
          
          Select-String 'C2FW_VERSION' $path

      - name: Cache Boost
        if: env.ENABLED == 'true'
        id: cache-boost
        uses: actions/cache@v4
        with:
          path: Cell2Fire/include/boost_1_84_0
          key: boost-${{ runner.os }}-1.84.0

      - name: Cache Dirent
        if: env.ENABLED == 'true'
        id: cache-dirent
        uses: actions/cache@v4
        with:
          path: Cell2Fire/include/dirent-1.25
          key: dirent-${{ runner.os }}-1.25

      - name: Cache vcpkg
        if: env.ENABLED == 'true'
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: Cell2Fire/include/vcpkg
          key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}

      - name: Download Dependencies
        if: env.ENABLED == 'true' && (steps.cache-vcpkg.outputs.cache-hit != 'true' || steps.cache-boost.outputs.cache-hit != 'true' || steps.cache-dirent.outputs.cache-hit != 'true')
        shell: pwsh
        env:
          CACHE_BOOST: ${{ steps.cache-boost.outputs.cache-hit }}
          CACHE_DIRENT: ${{ steps.cache-dirent.outputs.cache-hit }}
          CACHE_VCPKG: ${{ steps.cache-vcpkg.outputs.cache-hit }}
        run: |
          Write-Host "Downloading Windows dependencies..."
          cd Cell2Fire
          New-Item -ItemType Directory -Path "include" -Force

          Write-Host "Cache Boost: $CACHE_BOOST $($CACHE_BOOST -ne 'true')"
          Write-Host "Cache Boost: $CACHE_VCPKG $($CACHE_VCPKG -ne 'true')"

          # boost
          if ($CACHE_BOOST -ne 'true') {
            $fname = "boost_1_84_0.tar.gz"
            Invoke-WebRequest -Uri https://archives.boost.io/release/1.84.0/source/$fname -OutFile $fname
            tar -xzf $fname -C include
          } else {
            echo "Boost already cached"
          }

          # dirent
          if ($CACHE_DIRENT -ne 'true') {
            Invoke-WebRequest -Uri https://github.com/tronkko/dirent/archive/refs/tags/1.25.zip -OutFile dirent-1.25.zip
            Expand-Archive -Path .\dirent-1.25.zip -DestinationPath include
          } else {
            echo "Dirent already cached"
          }

          # tiffio
          if ($CACHE_VCPKG -ne 'true') {
            git clone https://github.com/microsoft/vcpkg.git include\vcpkg
          } else {
            echo "vcpkg already cached"
          }
          # Add your dependency download script here
          # This should download Boost, Dirent, and setup vcpkg

      - name: Setup MSBuild
        if: env.ENABLED == 'true'
        uses: microsoft/setup-msbuild@v2

      - name: Build with MSBuild
        if: env.ENABLED == 'true'
        shell: pwsh
        run: |
          cd Cell2Fire
          msbuild Cell2Fire.vcxproj /p:Configuration=Release /p:Platform=x64

      - name: Collect DLLs
        if: env.ENABLED == 'true'
        shell: pwsh
        run: |
          # Copy required DLLs to binaries folder
          mkdir -p binaries
          Copy-Item Cell2Fire/x64/Release/Cell2Fire.exe binaries/
          # Add DLL collection logic here

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binaries-Windows-x86_64
          path: binaries/*
          if-no-files-found: error

  test:
    needs: build
    runs-on: windows-latest
    if: inputs.enabled == true

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
          name: binaries-Windows-x86_64
          path: Cell2Fire

      - name: Run Tests
        shell: pwsh
        run: |
          cd test
          # Add Windows test script here
          Write-Host "Windows tests would run here"
